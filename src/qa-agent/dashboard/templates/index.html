<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-CORE Quality Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 2em;
            margin-right: 15px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
        }

        .metric-value {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .metric-label {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-good { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-critical { background: #e74c3c; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-good { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .progress-warning { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .progress-critical { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        .chart-container {
            width: 100%;
            height: 200px;
            margin: 20px 0;
            position: relative;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: #7f8c8d;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .alert {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #c0392b;
        }

        .alert-warning {
            background: rgba(243, 156, 18, 0.1);
            border-color: #f39c12;
            color: #d68910;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            border-color: #27ae60;
            color: #229954;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            font-size: 0.8em;
            z-index: 1000;
        }

        .connected { background: #27ae60; }
        .disconnected { background: #e74c3c; }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span class="status-indicator"></span>
        Connecting...
    </div>

    <div class="container">
        <div class="header">
            <h1>üöÄ AI-CORE Quality Dashboard</h1>
            <p class="subtitle">Real-time monitoring of test results, performance metrics, and security status</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn" onclick="exportReport('html')">üìä HTML Report</button>
            <button class="btn" onclick="exportReport('json')">üìã JSON Report</button>
            <button class="btn" onclick="exportReport('pdf')">üìÑ PDF Report</button>
            <select id="timeframe" onchange="updateTimeframe()">
                <option value="1h">Last Hour</option>
                <option value="24h" selected>Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
            </select>
        </div>

        <div class="dashboard-grid">
            <!-- Overall Quality Score -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                        üéØ
                    </div>
                    <div class="card-title">Overall Quality Score</div>
                </div>
                <div class="metric-value" id="qualityScore">
                    <div class="loading">Loading...</div>
                </div>
                <div class="metric-label">Grade: <span id="qualityGrade">-</span></div>
                <div class="progress-bar">
                    <div class="progress-fill progress-good" id="qualityProgress" style="width: 0%"></div>
                </div>
            </div>

            <!-- Test Results -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white;">
                        üß™
                    </div>
                    <div class="card-title">Test Results</div>
                </div>
                <div id="testResults">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white;">
                        ‚ö°
                    </div>
                    <div class="card-title">Performance</div>
                </div>
                <div id="performanceMetrics">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Security Status -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;">
                        üîí
                    </div>
                    <div class="card-title">Security Status</div>
                </div>
                <div id="securityStatus">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Test Coverage -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white;">
                        üìä
                    </div>
                    <div class="card-title">Test Coverage</div>
                </div>
                <div id="testCoverage">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- System Status -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #34495e, #2c3e50); color: white;">
                        üñ•Ô∏è
                    </div>
                    <div class="card-title">System Status</div>
                </div>
                <div id="systemStatus">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;">
                    üö®
                </div>
                <div class="card-title">Active Alerts</div>
            </div>
            <div id="alerts">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <!-- Quality Trends Chart -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
                    üìà
                </div>
                <div class="card-title">Quality Trends</div>
            </div>
            <div class="chart-container" id="trendsChart">
                <div class="loading">Loading chart...</div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let reconnectInterval = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            loadInitialData();
        });

        // WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
                clearInterval(reconnectInterval);
            };

            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateDashboard(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            socket.onclose = function() {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                scheduleReconnect();
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }

        function scheduleReconnect() {
            if (reconnectInterval) return;

            reconnectInterval = setInterval(() => {
                console.log('Attempting to reconnect...');
                initializeWebSocket();
            }, 5000);
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = '<span class="status-indicator"></span>Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = '<span class="status-indicator"></span>Disconnected';
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadQualityScore(),
                    loadTestResults(),
                    loadPerformanceMetrics(),
                    loadSecurityStatus(),
                    loadTestCoverage(),
                    loadSystemStatus(),
                    loadAlerts(),
                    loadQualityTrends()
                ]);
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // API calls
        async function apiCall(endpoint) {
            const response = await fetch(`/api${endpoint}`);
            if (!response.ok) {
                throw new Error(`API call failed: ${response.statusText}`);
            }
            return await response.json();
        }

        async function loadQualityScore() {
            try {
                const data = await apiCall('/quality/score');
                if (data.success) {
                    updateQualityScore(data.data);
                }
            } catch (error) {
                console.error('Error loading quality score:', error);
            }
        }

        async function loadTestResults() {
            try {
                const data = await apiCall('/tests/results');
                if (data.success) {
                    updateTestResults(data.data);
                }
            } catch (error) {
                console.error('Error loading test results:', error);
            }
        }

        async function loadPerformanceMetrics() {
            try {
                const data = await apiCall('/performance/metrics');
                if (data.success) {
                    updatePerformanceMetrics(data.data);
                }
            } catch (error) {
                console.error('Error loading performance metrics:', error);
            }
        }

        async function loadSecurityStatus() {
            try {
                const data = await apiCall('/security/status');
                if (data.success) {
                    updateSecurityStatus(data.data);
                }
            } catch (error) {
                console.error('Error loading security status:', error);
            }
        }

        async function loadTestCoverage() {
            try {
                const data = await apiCall('/tests/coverage');
                if (data.success) {
                    updateTestCoverage(data.data);
                }
            } catch (error) {
                console.error('Error loading test coverage:', error);
            }
        }

        async function loadSystemStatus() {
            try {
                const data = await apiCall('/system/status');
                if (data.success) {
                    updateSystemStatus(data.data);
                }
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        async function loadAlerts() {
            try {
                const data = await apiCall('/alerts');
                if (data.success) {
                    updateAlerts(data.data);
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        async function loadQualityTrends() {
            try {
                const timeframe = document.getElementById('timeframe').value;
                const data = await apiCall(`/quality/trends?timeframe=${timeframe}`);
                if (data.success) {
                    updateQualityTrends(data.data);
                }
            } catch (error) {
                console.error('Error loading quality trends:', error);
            }
        }

        // Update functions
        function updateQualityScore(data) {
            const scoreElement = document.getElementById('qualityScore');
            const gradeElement = document.getElementById('qualityGrade');
            const progressElement = document.getElementById('qualityProgress');

            scoreElement.textContent = data.overall_score.toFixed(1);
            gradeElement.textContent = data.grade;
            progressElement.style.width = `${data.overall_score}%`;

            // Update progress bar color based on score
            progressElement.className = 'progress-fill';
            if (data.overall_score >= 80) {
                progressElement.classList.add('progress-good');
            } else if (data.overall_score >= 60) {
                progressElement.classList.add('progress-warning');
            } else {
                progressElement.classList.add('progress-critical');
            }
        }

        function updateTestResults(data) {
            const element = document.getElementById('testResults');
            element.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Passed:</span>
                    <span style="color: #27ae60; font-weight: bold;">${data.passed || 0}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Failed:</span>
                    <span style="color: #e74c3c; font-weight: bold;">${data.failed || 0}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Skipped:</span>
                    <span style="color: #f39c12; font-weight: bold;">${data.skipped || 0}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill progress-good" style="width: ${data.success_rate || 0}%"></div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #7f8c8d;">
                    Success Rate: ${(data.success_rate || 0).toFixed(1)}%
                </div>
            `;
        }

        function updatePerformanceMetrics(data) {
            const element = document.getElementById('performanceMetrics');
            element.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Avg Response:</span>
                    <span style="font-weight: bold;">${data.avg_response_time || 0}ms</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>P95 Response:</span>
                    <span style="font-weight: bold;">${data.p95_response_time || 0}ms</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Throughput:</span>
                    <span style="font-weight: bold;">${data.throughput || 0} req/s</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Error Rate:</span>
                    <span style="color: ${(data.error_rate || 0) > 5 ? '#e74c3c' : '#27ae60'}; font-weight: bold;">
                        ${(data.error_rate || 0).toFixed(2)}%
                    </span>
                </div>
            `;
        }

        function updateSecurityStatus(data) {
            const element = document.getElementById('securityStatus');
            const statusColor = data.overall_status === 'secure' ? '#27ae60' :
                               data.overall_status === 'warning' ? '#f39c12' : '#e74c3c';

            element.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 1.5em; color: ${statusColor}; font-weight: bold;">
                        ${data.overall_status?.toUpperCase() || 'UNKNOWN'}
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Critical:</span>
                    <span style="color: #e74c3c; font-weight: bold;">${data.critical_vulnerabilities || 0}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>High:</span>
                    <span style="color: #f39c12; font-weight: bold;">${data.high_vulnerabilities || 0}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Last Scan:</span>
                    <span style="font-size: 0.9em; color: #7f8c8d;">${data.last_scan || 'Never'}</span>
                </div>
            `;
        }

        function updateTestCoverage(data) {
            const element = document.getElementById('testCoverage');
            const coverage = data.overall_coverage || 0;

            element.innerHTML = `
                <div class="metric-value" style="font-size: 2em; margin: 10px 0;">
                    ${coverage.toFixed(1)}%
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${coverage >= 80 ? 'progress-good' : coverage >= 60 ? 'progress-warning' : 'progress-critical'}"
                         style="width: ${coverage}%"></div>
                </div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Lines:</span>
                        <span>${data.line_coverage || 0}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Functions:</span>
                        <span>${data.function_coverage || 0}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Branches:</span>
                        <span>${data.branch_coverage || 0}%</span>
                    </div>
                </div>
            `;
        }

        function updateSystemStatus(data) {
            const element = document.getElementById('systemStatus');
            element.innerHTML = `
                <div style="margin-bottom: 15px;">
                    ${(data.services || []).map(service => `
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span class="status-indicator ${service.status === 'healthy' ? 'status-good' : 'status-critical'}"></span>
                            <span style="flex: 1;">${service.name}</span>
                            <span style="font-size: 0.9em; color: #7f8c8d;">${service.status}</span>
                        </div>
                    `).join('')}
                </div>
                <div style="border-top: 1px solid #ecf0f1; padding-top: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>CPU:</span>
                        <span>${data.cpu_usage || 0}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Memory:</span>
                        <span>${data.memory_usage || 0}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Disk:</span>
                        <span>${data.disk_usage || 0}%</span>
                    </div>
                </div>
            `;
        }

        function updateAlerts(data) {
            const element = document.getElementById('alerts');

            if (!data || data.length === 0) {
                element.innerHTML = '<div class="alert-success">‚úÖ No active alerts</div>';
                return;
            }

            element.innerHTML = data.map(alert => `
                <div class="alert ${alert.severity === 'critical' ? '' : alert.severity === 'warning' ? 'alert-warning' : 'alert-success'}">
                    <strong>${alert.title}</strong><br>
                    ${alert.message}<br>
                    <small>üìÖ ${new Date(alert.timestamp).toLocaleString()}</small>
                </div>
            `).join('');
        }

        function updateQualityTrends(data) {
            const element = document.getElementById('trendsChart');
            // For now, show a simple trend indication
            // In a real implementation, you'd integrate with a charting library like Chart.js
            element.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div style="font-size: 2em; margin-bottom: 10px;">
                        ${data.trend_direction === 'improving' ? 'üìà' : data.trend_direction === 'declining' ? 'üìâ' : '‚û°Ô∏è'}
                    </div>
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
                        ${data.trend_direction || 'Stable'}
                    </div>
                    <div style="color: #7f8c8d;">
                        ${data.quality_score_change > 0 ? '+' : ''}${data.quality_score_change || 0} points
                    </div>
                </div>
            `;
        }

        function updateDashboard(data) {
            if (data.quality_score) updateQualityScore(data.quality_score);
            if (data.test_results) updateTestResults(data.test_results);
            if (data.performance_metrics) updatePerformanceMetrics(data.performance_metrics);
            if (data.security_status) updateSecurityStatus(data.security_status);
            if (data.test_coverage) updateTestCoverage(data.test_coverage);
            if (data.system_status) updateSystemStatus(data.system_status);
            if (data.alerts) updateAlerts(data.alerts);
            if (data.quality_trends) updateQualityTrends(data.quality_trends);
        }

        // Control functions
        function refreshData() {
            loadInitialData();
        }

        function updateTimeframe() {
            loadQualityTrends();
        }

        async function exportReport(format) {
            try {
                const response = await fetch('/api/reports/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        format: format,
                        timeframe: document.getElementById('timeframe').value
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `quality_report.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    console.error('Export failed:', response.statusText);
                    alert('Failed to export report. Please try again.');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export report. Please try again.');
            }
        }
    </script>
</body>
</html>
